<div layout:decorate="~{layouts/customer-layout}" xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

    <div layout:fragment="content">
        <div class="container">
            <a th:href="@{/}" class="btn btn-secondary mb-3">Tiếp tục mua sắm</a>

            <!-- Tiêu đề + số lượng sản phẩm -->
            <h1 class="d-flex justify-content-between align-items-center">
                <span>Giỏ hàng của tôi</span>
            </h1>
            <small class="text-muted" th:text="'(' + ${#lists.size(cartItems)} + ' sản phẩm)'"></small>

            <!-- Messages -->
            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <table class="table table-bordered align-middle">
                <thead>
                <tr>
                    <th style="width: 80px;">
                        <form th:action="@{/customer/shopping-cart/select-all}" method="post" style="display:inline;">
                            <input type="checkbox" id="selectAllCheckbox"
                                   th:checked="${#lists.size(selectedIds) == #lists.size(cartItems) and !#lists.isEmpty(cartItems)}"
                                   onchange="this.form.submit()">
                            <label for="selectAllCheckbox" style="margin-left: 4px;">Tất cả</label>
                        </form>
                    </th>
                    <th>Sản phẩm</th>
                    <th>Đơn giá</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                    <th>Thao tác</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${#lists.isEmpty(cartItems)}">
                    <td colspan="6" class="text-center text-muted py-4">
                        Chưa có sản phẩm nào trong giỏ hàng.
                    </td>
                </tr>

                <tr th:each="item : ${cartItems}">
                    <td>
                        <form th:action="@{/customer/shopping-cart/select}" method="post">
                            <input type="hidden" name="cartIds" th:value="${item.product.id}">
                            <input type="checkbox" th:checked="${#lists.contains(selectedIds, item.product.id)}"
                                   onchange="this.form.submit()">
                        </form>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img th:src="@{${item.product.main_image_url}}" alt="Product Image"
                                 style="width: 60px; height: 60px; object-fit: cover; margin-right: 10px; border-radius: 8px;">
                            <a th:href="@{/product/{id}(id=${item.product.id})}"
                               th:text="${item.product.name}"
                               style="text-decoration: none; color: #0d6efd; font-weight: 500;"
                               onmouseover="this.style.textDecoration='underline'"
                               onmouseout="this.style.textDecoration='none'"></a>
                        </div>
                    </td>
                    <td>
                        <span th:text="${item.product.price + ' / ' + item.product.unit.name}"></span>
                    </td>
                    <td>
                        <form th:action="@{/customer/shopping-cart/update}" method="post" style="display: inline;">
                            <input type="hidden" name="productId" th:value="${item.product.id}">
                            <input type="number" name="quantity" th:value="${item.quantity}" min="1"
                                   class="form-control form-control-sm text-center"
                                   style="width: 80px; display: inline-block;"
                                   onchange="this.form.submit()">
                        </form>
                    </td>
                    <td>
                        <span class="item-subtotal fw-semibold" th:text="${item.product.price * item.quantity + ' VND'}"></span>
                    </td>
                    <td>
                        <form th:action="@{/customer/shopping-cart/remove}" method="post">
                            <input type="hidden" name="productId" th:value="${item.product.id}">
                            <button type="submit" class="btn btn-danger btn-sm"
                                    onclick="return confirm('Bạn có chắc muốn xóa sản phẩm này?')">
                                Xóa
                            </button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="row mt-3">
                <div class="col-md-6">
                    <h4>
                        Tổng tiền đã chọn:
                        <span th:text="${totalAmount}">0 VND</span>
                    </h4>
                    <p th:if="${totalAmount == 0}" class="text-muted">
                        Vui lòng chọn sản phẩm để xem tổng tiền
                    </p>
                </div>
                <div class="col-md-6 text-end">
                    <form th:action="@{/customer/shopping-cart/check-out}" method="post" id="checkoutForm">
                        <input th:each="id : ${selectedIds}" type="hidden" name="cartIds" th:value="${id}">
                        <button type="submit" class="btn btn-primary px-4"
                                th:disabled="${totalAmount == 0}">
                            Thanh toán
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const checkoutForm = document.getElementById('checkoutForm');
        const checkoutButton = checkoutForm.querySelector('button[type="submit"]');

        checkoutButton.addEventListener('click', function (e) {
            let changed = false;
            document.querySelectorAll('input[name="quantity"]').forEach(input => {
                if (input.value !== input.defaultValue) changed = true;
            });

            if (changed) {
                e.preventDefault();
                alert('Vui lòng bấm Enter hoặc click ra ngoài để cập nhật số lượng trước khi thanh toán.');
            }
        });
    });
</script>